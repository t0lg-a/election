<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VoteHub â€” Polling Aggregator</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—³ï¸</text></svg>">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..800;1,9..40,300..800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN SYSTEM
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg-body: #f0f0ee;
      --bg-card: #ffffff;
      --bg-card-elevated: #ffffff;
      --bg-inset: #eaeae8;
      --bg-glass: rgba(255,255,255,0.72);
      --text-primary: #111111;
      --text-secondary: #555555;
      --text-tertiary: #888888;
      --border-main: rgba(0,0,0,0.08);
      --border-subtle: rgba(0,0,0,0.04);

      --dem-blue: #2260d3;
      --dem-blue-light: rgba(34,96,211,0.08);
      --dem-blue-glow: rgba(34,96,211,0.25);
      --rep-red: #d63031;
      --rep-red-light: rgba(214,48,49,0.08);
      --rep-red-glow: rgba(214,48,49,0.25);
      --approve-green: #0d9f6e;
      --approve-green-light: rgba(13,159,110,0.08);
      --disapprove-orange: #c0392b;
      --disapprove-orange-light: rgba(192,57,43,0.08);

      --accent: #2260d3;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
      --shadow-card: 0 1px 3px rgba(0,0,0,0.03), 0 6px 24px rgba(0,0,0,0.04);
      --shadow-card-hover: 0 4px 12px rgba(0,0,0,0.06), 0 16px 40px rgba(0,0,0,0.08);

      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;

      --font-display: 'Instrument Serif', Georgia, serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;

      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-spring: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #0c0c0e;
        --bg-card: #18181b;
        --bg-card-elevated: #1f1f23;
        --bg-inset: #111114;
        --bg-glass: rgba(24,24,27,0.78);
        --text-primary: #f0f0f0;
        --text-secondary: #a0a0a0;
        --text-tertiary: #666666;
        --border-main: rgba(255,255,255,0.08);
        --border-subtle: rgba(255,255,255,0.04);

        --dem-blue: #5b9aff;
        --dem-blue-light: rgba(91,154,255,0.12);
        --dem-blue-glow: rgba(91,154,255,0.3);
        --rep-red: #ff6b6b;
        --rep-red-light: rgba(255,107,107,0.12);
        --rep-red-glow: rgba(255,107,107,0.3);
        --approve-green: #34d399;
        --approve-green-light: rgba(52,211,153,0.12);
        --disapprove-orange: #ff6b6b;
        --disapprove-orange-light: rgba(255,107,107,0.12);

        --accent: #5b9aff;
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
        --shadow-lg: 0 12px 40px rgba(0,0,0,0.4);
        --shadow-card: 0 1px 3px rgba(0,0,0,0.15), 0 6px 24px rgba(0,0,0,0.2);
        --shadow-card-hover: 0 4px 12px rgba(0,0,0,0.25), 0 16px 40px rgba(0,0,0,0.35);
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & BASE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg-body);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Subtle grid pattern on body */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--border-subtle) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
      opacity: 0.5;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-main);
      padding: 0 2rem;
      transition: box-shadow var(--transition-smooth);
    }
    .site-header.scrolled {
      box-shadow: var(--shadow-md);
    }

    .header-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 68px;
      gap: 1rem;
    }

    .logo-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--dem-blue), var(--rep-red));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 1.1rem;
      font-family: var(--font-mono);
      letter-spacing: -0.05em;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(34,96,211,0.25);
    }

    .logo-text h1 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 400;
      letter-spacing: -0.02em;
      line-height: 1.1;
      color: var(--text-primary);
    }

    .logo-text .tagline {
      font-size: 0.72rem;
      color: var(--text-tertiary);
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .loading-spinner {
      display: none;
      color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Filter Toggle Switch */
    .filter-switch {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      user-select: none;
      padding: 6px 14px 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-main);
      background: var(--bg-card);
      transition: all var(--transition-fast);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .filter-switch:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .switch-track {
      width: 36px;
      height: 20px;
      border-radius: 999px;
      background: var(--text-tertiary);
      position: relative;
      transition: background var(--transition-fast);
      flex-shrink: 0;
    }
    .switch-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      transition: transform var(--transition-fast);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .filter-switch input { display: none; }
    .filter-switch input:checked + .switch-track {
      background: var(--accent);
    }
    .filter-switch input:checked + .switch-track::after {
      transform: translateX(16px);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN LAYOUT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      position: relative;
      z-index: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ALERT / STATUS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .alert {
      padding: 0.85rem 1.25rem;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      font-weight: 500;
      display: none;
      animation: slideDown 0.35s cubic-bezier(0.22, 1, 0.36, 1);
      border: 1px solid transparent;
    }
    .alert.info { background: var(--dem-blue-light); color: var(--dem-blue); border-color: var(--dem-blue-glow); }
    .alert.error { background: var(--rep-red-light); color: var(--rep-red); border-color: var(--rep-red-glow); }
    .alert.warn { background: rgba(245, 158, 11, 0.1); color: #b45309; border-color: rgba(245, 158, 11, 0.2); }
    .alert.success { background: var(--approve-green-light); color: var(--approve-green); border-color: rgba(13,159,110,0.2); }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADLINE STAT BANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .headline-banner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      animation: fadeUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.1s both;
    }

    .headline-card {
      background: var(--bg-card);
      border: 1px solid var(--border-main);
      border-radius: var(--radius-lg);
      padding: 1.75rem 2rem;
      box-shadow: var(--shadow-card);
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
    }
    .headline-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-card-hover);
    }

    .headline-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }
    .headline-card.approval-headline::before {
      background: linear-gradient(90deg, var(--approve-green), var(--disapprove-orange));
    }
    .headline-card.gb-headline::before {
      background: linear-gradient(90deg, var(--dem-blue), var(--rep-red));
    }

    .headline-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-tertiary);
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .headline-numbers {
      display: flex;
      align-items: baseline;
      gap: 1.5rem;
    }

    .headline-num {
      font-family: var(--font-mono);
      font-size: 2.75rem;
      font-weight: 600;
      line-height: 1;
      letter-spacing: -0.03em;
    }

    .headline-sep {
      font-size: 1.5rem;
      color: var(--text-tertiary);
      font-weight: 300;
    }

    .headline-net {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 8px;
      margin-left: auto;
      letter-spacing: -0.02em;
      align-self: center;
    }

    .headline-meta {
      margin-top: 0.75rem;
      font-size: 0.76rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .trend-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-weight: 600;
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .trend-badge.up { color: var(--approve-green); background: var(--approve-green-light); }
    .trend-badge.down { color: var(--rep-red); background: var(--rep-red-light); }
    .trend-badge.flat { color: var(--text-tertiary); background: var(--bg-inset); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-main);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow-card);
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      box-shadow: var(--shadow-card-hover);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 1.6rem;
      font-weight: 400;
      line-height: 1.15;
      color: var(--text-primary);
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--text-tertiary);
      font-weight: 500;
      margin-top: 0.2rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATS ROW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.75rem;
    }

    .stat-box {
      background: var(--bg-inset);
      padding: 1.1rem 1.25rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      transition: border-color var(--transition-fast);
    }
    .stat-box:hover {
      border-color: var(--border-main);
    }

    .stat-label {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }

    .stat-value {
      font-family: var(--font-mono);
      font-size: 1.6rem;
      font-weight: 600;
      line-height: 1.2;
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      letter-spacing: -0.02em;
    }

    .trend-indicator {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      font-family: var(--font-mono);
    }
    .trend-up { color: var(--approve-green); background: var(--approve-green-light); }
    .trend-down { color: var(--rep-red); background: var(--rep-red-light); }
    .trend-flat { color: var(--text-tertiary); background: var(--bg-inset); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHART CONTAINERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .plot-container {
      width: 100%;
      height: 480px;
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .plot-container.diff {
      height: 260px;
      margin-top: 1.25rem;
      display: none;
    }

    .chart-note {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 0.75rem;
      font-style: italic;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CUSTOMIZE PANELS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      appearance: none;
      border: 1px solid var(--border-main);
      background: var(--bg-card);
      color: var(--text-secondary);
      padding: 0.45rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.76rem;
      font-family: var(--font-body);
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .btn:hover {
      background: var(--bg-inset);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn:active { transform: scale(0.97); }
    .btn .icon { font-size: 0.9rem; opacity: 0.7; }

    .custom-panel {
      margin: 0 0 1.75rem 0;
      padding: 1.25rem;
      border: 1px solid var(--border-main);
      border-radius: var(--radius-md);
      background: var(--bg-inset);
      animation: slideDown 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .custom-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      align-items: start;
    }

    .custom-item {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .custom-label {
      font-size: 0.68rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .custom-help {
      font-size: 0.72rem;
      color: var(--text-tertiary);
      line-height: 1.4;
    }

    .custom-row {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .custom-row input[type="number"] {
      width: 5.25rem;
      padding: 0.4rem 0.6rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-main);
      background: var(--bg-card);
      color: var(--text-primary);
      font-weight: 600;
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }

    .custom-row input[type="range"] {
      flex: 1;
      min-width: 140px;
      accent-color: var(--accent);
    }

    label.custom-check {
      display: flex;
      gap: 0.55rem;
      align-items: center;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    label.custom-check input {
      accent-color: var(--accent);
      width: 1rem;
      height: 1rem;
      margin: 0;
    }

    .small {
      font-size: 0.78rem;
      color: var(--text-tertiary);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       POLLSTER LIST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .pollster-section .section-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-tertiary);
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .pollster-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      max-height: 160px;
      overflow-y: auto;
      padding: 0.25rem 0;
    }

    .pollster-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      background: var(--bg-inset);
      border: 1px solid var(--border-main);
      color: var(--text-secondary);
      transition: all var(--transition-fast);
    }
    .pollster-tag:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--dem-blue-light);
    }

    .filter-mode-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .filter-mode-badge.strict {
      background: var(--approve-green-light);
      color: var(--approve-green);
    }
    .filter-mode-badge.all {
      background: var(--dem-blue-light);
      color: var(--dem-blue);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOOTER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .site-footer {
      text-align: center;
      padding: 2.5rem 2rem;
      color: var(--text-tertiary);
      font-size: 0.78rem;
      border-top: 1px solid var(--border-main);
      background: var(--bg-card);
      margin-top: 1rem;
      position: relative;
      z-index: 1;
    }

    .site-footer .footer-brand {
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEBUG
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #debugCard { display: none; }
    #debugOut {
      background: #0a0a0a;
      color: #4ade80;
      padding: 1rem;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 0.78rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .anim-stagger-1 { animation: fadeUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.15s both; }
    .anim-stagger-2 { animation: fadeUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.25s both; }
    .anim-stagger-3 { animation: fadeUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.35s both; }
    .anim-stagger-4 { animation: fadeUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.45s both; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 768px) {
      .site-header { padding: 0 1rem; }
      .header-inner { height: 56px; }
      .logo-text h1 { font-size: 1.2rem; }
      .logo-text .tagline { display: none; }
      main { padding: 1.25rem; gap: 1rem; }
      .headline-banner { grid-template-columns: 1fr; gap: 1rem; }
      .headline-num { font-size: 2rem; }
      .card { padding: 1.25rem; }
      .card-title { font-size: 1.3rem; }
      .plot-container { height: 360px; }
      .stats-row { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 480px) {
      .headline-numbers { gap: 0.75rem; }
      .headline-num { font-size: 1.6rem; }
      .headline-net { font-size: 0.8rem; }
      .stats-row { grid-template-columns: 1fr; }
      .plot-container { height: 300px; }
    }

    /* scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
  </style>
</head>

<body>

  <!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
  <header class="site-header" id="siteHeader">
    <div class="header-inner">
      <div class="logo-group">
        <div class="logo-icon">VH</div>
        <div class="logo-text">
          <h1>VoteHub</h1>
          <div class="tagline">Polling Aggregation Dashboard</div>
        </div>
      </div>
      <div class="header-controls">
        <svg id="loadingIndicator" class="loading-spinner" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <label class="filter-switch" title="Toggle between quality-filtered pollsters and all sources">
          <input type="checkbox" id="toggleFilter" checked onchange="app.refreshViews()">
          <span class="switch-track"></span>
          <span id="filterLabelText">Quality Filter</span>
        </label>
      </div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â• -->
  <main>
    <div id="globalStatus" class="alert info">Initializingâ€¦</div>

    <!-- HEADLINE BANNER -->
    <div class="headline-banner" id="headlineBanner" style="display:none;">
      <!-- Approval Headline -->
      <div class="headline-card approval-headline">
        <div class="headline-label">Presidential Approval</div>
        <div class="headline-numbers">
          <span class="headline-num" id="hlApprove" style="color: var(--approve-green);">â€”</span>
          <span class="headline-sep">â€“</span>
          <span class="headline-num" id="hlDisapprove" style="color: var(--disapprove-orange);">â€”</span>
          <span class="headline-net" id="hlApprovalNet">â€”</span>
        </div>
        <div class="headline-meta">
          <span id="hlApprovalTrend"></span>
          <span id="hlApprovalPolls"></span>
        </div>
      </div>

      <!-- Generic Ballot Headline -->
      <div class="headline-card gb-headline">
        <div class="headline-label">Generic Ballot</div>
        <div class="headline-numbers">
          <span class="headline-num" id="hlDem" style="color: var(--dem-blue);">â€”</span>
          <span class="headline-sep">â€“</span>
          <span class="headline-num" id="hlRep" style="color: var(--rep-red);">â€”</span>
          <span class="headline-net" id="hlGBNet">â€”</span>
        </div>
        <div class="headline-meta">
          <span id="hlGBTrend"></span>
          <span id="hlGBPolls"></span>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â• APPROVAL CARD â•â•â•â•â•â•â• -->
    <div class="card anim-stagger-1">
      <div class="card-header">
        <div>
          <div class="card-title">Presidential Approval</div>
          <div class="card-subtitle">Approve vs Disapprove â€” rolling average trendlines</div>
        </div>
        <button class="btn" type="button" onclick="app.toggleCustomize('approval')">
          <span class="icon">âš™</span> Customize
        </button>
      </div>

      <div class="stats-row" id="approvalStats">
        <div class="stat-box">
          <div class="stat-label">Approve Avg</div>
          <div class="stat-value">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Disapprove Avg</div>
          <div class="stat-value">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Net Approval</div>
          <div class="stat-value" id="netApprovalValue">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Polls</div>
          <div class="stat-value">â€”</div>
        </div>
      </div>

      <div id="approvalCustomizePanel" class="custom-panel" style="display:none;">
        <div class="custom-grid">
          <div class="custom-item">
            <div class="custom-label">Moving avg window (days)</div>
            <div class="custom-row">
              <input id="approvalMADaysRange" type="range" min="3" max="120" step="1" value="14">
              <input id="approvalMADays" type="number" min="3" max="365" step="1" value="14">
            </div>
            <div class="custom-help">If "Auto min polls" is on, window expands until enough polls exist.</div>
          </div>
          <div class="custom-item">
            <div class="custom-label">Auto min polls</div>
            <div class="custom-row">
              <label class="custom-check"><input type="checkbox" id="approvalAutoMin"><span>Enable</span></label>
              <span class="small">Min:</span>
              <input id="approvalMinPolls" type="number" min="3" max="60" step="1" value="12">
            </div>
            <div class="custom-help">Use the most recent N polls per day.</div>
          </div>
          <div class="custom-item">
            <div class="custom-label">Compare sources</div>
            <div class="custom-row" style="flex-direction:column; align-items:flex-start; gap:0.5rem;">
              <label class="custom-check"><input type="checkbox" id="approvalCompare"><span>Show filtered + all</span></label>
              <label class="custom-check"><input type="checkbox" id="approvalShowDiff"><span>Show difference</span></label>
            </div>
          </div>
        </div>
      </div>

      <div id="approvalChart" class="plot-container"></div>
      <div id="approvalDiffChart" class="plot-container diff"></div>
      <div class="chart-note">Includes "Strongly" variations where available. Hover dots for poll details.</div>
    </div>

    <!-- â•â•â•â•â•â•â• GENERIC BALLOT CARD â•â•â•â•â•â•â• -->
    <div class="card anim-stagger-2">
      <div class="card-header">
        <div>
          <div class="card-title">Generic Congressional Ballot</div>
          <div class="card-subtitle">Democrat vs Republican â€” rolling average trendlines</div>
        </div>
        <button class="btn" type="button" onclick="app.toggleCustomize('gb')">
          <span class="icon">âš™</span> Customize
        </button>
      </div>

      <div class="stats-row" id="gbStats">
        <div class="stat-box">
          <div class="stat-label">Democratic Avg</div>
          <div class="stat-value">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Republican Avg</div>
          <div class="stat-value">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Margin</div>
          <div class="stat-value" id="gbMarginValue">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Polls</div>
          <div class="stat-value">â€”</div>
        </div>
      </div>

      <div id="gbCustomizePanel" class="custom-panel" style="display:none;">
        <div class="custom-grid">
          <div class="custom-item">
            <div class="custom-label">Moving avg window (days)</div>
            <div class="custom-row">
              <input id="gbMADaysRange" type="range" min="3" max="180" step="1" value="30">
              <input id="gbMADays" type="number" min="3" max="365" step="1" value="30">
            </div>
            <div class="custom-help">If "Auto min polls" is on, window expands until enough polls exist.</div>
          </div>
          <div class="custom-item">
            <div class="custom-label">Auto min polls</div>
            <div class="custom-row">
              <label class="custom-check"><input type="checkbox" id="gbAutoMin"><span>Enable</span></label>
              <span class="small">Min:</span>
              <input id="gbMinPolls" type="number" min="3" max="60" step="1" value="12">
            </div>
            <div class="custom-help">Use the most recent N polls per day.</div>
          </div>
          <div class="custom-item">
            <div class="custom-label">Compare sources</div>
            <div class="custom-row" style="flex-direction:column; align-items:flex-start; gap:0.5rem;">
              <label class="custom-check"><input type="checkbox" id="gbCompare"><span>Show filtered + all</span></label>
              <label class="custom-check"><input type="checkbox" id="gbShowDiff"><span>Show difference</span></label>
            </div>
          </div>
        </div>
      </div>

      <div id="gbChart" class="plot-container"></div>
      <div id="gbDiffChart" class="plot-container diff"></div>
      <div class="chart-note">Hover over dots for individual poll details. Spike lines track across time.</div>
    </div>

    <!-- â•â•â•â•â•â•â• POLLSTERS CARD â•â•â•â•â•â•â• -->
    <div class="card anim-stagger-3">
      <div class="card-header">
        <div>
          <div class="card-title">Trusted Pollsters</div>
          <div class="card-subtitle">Quality-filtered source allowlist</div>
        </div>
        <span class="filter-mode-badge strict" id="filterModeBadge">
          <span id="filterModeText">Strict Allowlist</span>
        </span>
      </div>
      <div class="pollster-section">
        <div class="section-label">Showing polls from these sources</div>
        <div class="pollster-grid" id="pollsterList"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â• DEBUG CARD â•â•â•â•â•â•â• -->
    <div class="card" id="debugCard">
      <div class="card-header">
        <div class="card-title">Debug Log</div>
      </div>
      <pre id="debugOut"></pre>
    </div>
  </main>

  <!-- â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â• -->
  <footer class="site-footer">
    <div class="footer-brand">VoteHub</div>
    <p>Dashboard Â© <span id="year"></span>. Data aggregated daily from public polling sources.</p>
    <p style="margin-top:0.35rem; opacity:0.7;">Polls are snapshots in time. Rolling averages may lag behind breaking news.</p>
  </footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/**
 * VoteHub Dashboard â€” Enhanced v5
 * Reads from polls.json generated by GitHub Actions.
 */

const CONFIG = {
  approvalWindow: 14,
  gbWindow: 30,
  debug: new URLSearchParams(location.search).has("debug")
};

const CUSTOM = {
  approval: { maDays: 14, autoMin: false, minPolls: 12, compare: false, showDiff: false },
  gb:       { maDays: 30, autoMin: false, minPolls: 12, compare: false, showDiff: false }
};

document.getElementById("year").textContent = new Date().getFullYear();

// Sticky header shadow on scroll
const header = document.getElementById('siteHeader');
window.addEventListener('scroll', () => {
  header.classList.toggle('scrolled', window.scrollY > 8);
}, { passive: true });

const STATE = {
  approvalData: [],
  gbData: [],
  isDemoMode: false,
  filterStrict: true
};

/* â•â•â•â•â•â•â•â•â•â•â• POLLSTER ALLOWLIST â•â•â•â•â•â•â•â•â•â•â• */
const ALLOWED_POLLSTERS = [
  { label: "YouGov", pattern: /yougov/ },
  { label: "Verasight", pattern: /verasight/ },
  { label: "Ipsos", pattern: /ipsos/ },
  { label: "ARG", pattern: /americanresearchgroup|arg\b/ },
  { label: "TIPP", pattern: /tipp/ },
  { label: "Emerson", pattern: /emerson/ },
  { label: "Gallup", pattern: /gallup/ },
  { label: "Marist", pattern: /marist/ },
  { label: "Quinnipiac", pattern: /quinnipiac/ },
  { label: "AP-NORC", pattern: /apnorc|ap\-norc|norc/ },
  { label: "Marquette", pattern: /marquette/ },
  { label: "CNN/SSRS", pattern: /cnnssrs|cnn\/ssrs|ssrs/ },
  { label: "AtlasIntel", pattern: /atlasintel|atlas/ },
  { label: "Beacon/Shaw", pattern: /beaconresearch|shaw/ },
  { label: "Hart/POS", pattern: /hartresearch|publicopinionstrategies/ },
  { label: "Pew", pattern: /pewresearch|pew/ },
  { label: "SurveyMonkey", pattern: /surveymonkey/ },
  { label: "Leger", pattern: /leger/ },
  { label: "UMass", pattern: /massachusetts|umass|departmentofpoliticalscience/ },
  { label: "NYT/Siena", pattern: /siena|newyorktimes/ },
  { label: "Fox News", pattern: /foxnews/ },
  { label: "WSJ", pattern: /wallstreetjournal|wsj/ },
];

/* â•â•â•â•â•â•â•â•â•â•â• UTILITIES â•â•â•â•â•â•â•â•â•â•â• */
const $ = (id) => document.getElementById(id);

function log(msg) {
  if (CONFIG.debug) {
    $('debugCard').style.display = 'block';
    $('debugOut').textContent += `[${new Date().toISOString().slice(11,19)}] ${msg}\n`;
  }
}

function showStatus(msg, type = 'info') {
  const el = $('globalStatus');
  el.textContent = msg;
  el.className = `alert ${type}`;
  el.style.display = 'block';
  if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 4000);
}

function norm(s) {
  return String(s || "").toLowerCase().replace(/&/g, "and").replace(/[^a-z0-9]+/g, "");
}

function isAllowed(pollsterName, strict = STATE.filterStrict) {
  if (!strict) return true;
  const n = norm(pollsterName);
  return ALLOWED_POLLSTERS.some(x => x.pattern.test(n));
}

function parseDate(s) { return new Date(`${s}T00:00:00Z`); }

/* â•â•â•â•â•â•â•â•â•â•â• MATH â•â•â•â•â•â•â•â•â•â•â• */

function calculateRollingAvg(points, windowDays) {
  if (!points.length) return [];
  const sorted = points.slice().sort((a, b) => a.date - b.date);
  const msPerDay = 86400000;
  const times = sorted.map(p => p.date.getTime());
  const prefix = [0];
  for (let i = 0; i < sorted.length; i++) prefix.push(prefix[prefix.length - 1] + sorted[i].value);

  const output = [];
  const startTs = times[0];
  const endTs = times[times.length - 1];
  let idx = 0, left = 0;
  for (let t = startTs; t <= endTs; t += msPerDay) {
    while (idx < times.length && times[idx] <= t) idx++;
    const windowStart = t - (windowDays * msPerDay);
    while (left < idx && times[left] <= windowStart) left++;
    const count = idx - left;
    if (count > 0) {
      const sum = prefix[idx] - prefix[left];
      output.push({ date: new Date(t), value: sum / count, count, windowDays });
    }
  }
  return output;
}

function calculateRollingAvgMinPolls(points, minPolls) {
  if (!points.length) return [];
  const sorted = points.slice().sort((a, b) => a.date - b.date);
  const msPerDay = 86400000;
  const times = sorted.map(p => p.date.getTime());
  const prefix = [0];
  for (let i = 0; i < sorted.length; i++) prefix.push(prefix[prefix.length - 1] + sorted[i].value);

  const output = [];
  const startTs = times[0];
  const endTs = times[times.length - 1];
  let idx = 0;
  for (let t = startTs; t <= endTs; t += msPerDay) {
    while (idx < times.length && times[idx] <= t) idx++;
    if (idx === 0) continue;
    let startIndex = Math.max(0, idx - Math.max(1, minPolls));
    const startTime = times[startIndex];
    while (startIndex > 0 && times[startIndex - 1] === startTime) startIndex--;
    const count = idx - startIndex;
    const sum = prefix[idx] - prefix[startIndex];
    const windowDays = Math.max(0, Math.round((t - startTime) / msPerDay));
    output.push({ date: new Date(t), value: sum / count, count, windowDays });
  }
  return output;
}

function toDayKey(d) { return d.toISOString().slice(0, 10); }

function diffSeries(seriesA, seriesB) {
  const mapB = new Map(seriesB.map(p => [toDayKey(p.date), p]));
  const out = [];
  for (const a of seriesA) {
    const k = toDayKey(a.date);
    const b = mapB.get(k);
    if (!b) continue;
    out.push({ date: a.date, value: a.value - b.value, countA: a.count ?? null, countB: b.count ?? null });
  }
  return out;
}

function getAnswer(poll, keys) {
  if (!poll.answers) return null;
  for (const ans of poll.answers) {
    const c = norm(ans.choice);
    if (c.includes('disapprove') && keys.some(k => norm(k).includes('approve') && !norm(k).includes('dis'))) continue;
    for (const key of keys) {
      if (c.includes(norm(key))) return parseFloat(ans.pct);
    }
  }
  return null;
}

function getTrendHTML(series) {
  if (series.length < 2) return '';
  const current = series[series.length - 1].value;
  const lookbackIndex = Math.max(0, series.length - 8);
  const past = series[lookbackIndex].value;
  const diff = current - past;
  let arrow, cls;
  if (diff > 0.5) { arrow = 'â†‘'; cls = 'trend-up'; }
  else if (diff < -0.5) { arrow = 'â†“'; cls = 'trend-down'; }
  else { arrow = 'â†’'; cls = 'trend-flat'; }
  return `<span class="trend-indicator ${cls}" title="${diff > 0 ? '+' : ''}${diff.toFixed(1)} over ~1 week">${arrow} ${Math.abs(diff).toFixed(1)}</span>`;
}

function getTrendBadge(series) {
  if (series.length < 2) return '';
  const current = series[series.length - 1].value;
  const lookbackIndex = Math.max(0, series.length - 8);
  const past = series[lookbackIndex].value;
  const diff = current - past;
  let arrow, cls;
  if (diff > 0.5) { arrow = 'â†‘'; cls = 'up'; }
  else if (diff < -0.5) { arrow = 'â†“'; cls = 'down'; }
  else { arrow = 'â†’'; cls = 'flat'; }
  return `<span class="trend-badge ${cls}">${arrow} ${Math.abs(diff).toFixed(1)}</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â• MOCK DATA â•â•â•â•â•â•â•â•â•â•â• */

function generateMockData(type) {
  const data = [];
  const pollsters = ALLOWED_POLLSTERS.map(p => p.label).concat(["Unknown Polling", "Generic Analytics"]);
  const now = new Date();
  let value = type === 'approval' ? 42 : 2;
  for (let i = 365; i >= 0; i--) {
    const date = new Date(now.getTime() - i * 86400000);
    value += (Math.random() - 0.5) * 1.5;
    const pollsToday = Math.floor(Math.random() * 2.5);
    for (let j = 0; j < pollsToday; j++) {
      const variance = (Math.random() - 0.5) * 6;
      const pollVal = value + variance;
      const pollster = pollsters[Math.floor(Math.random() * pollsters.length)];
      let entry = { date, pollster, sample_size: 500 + Math.floor(Math.random() * 1000), url: "#" };
      if (type === 'approval') { entry.approve = pollVal; entry.disapprove = 100 - pollVal - 5; }
      else { entry.dem = 46 + (pollVal / 2); entry.rep = 46 - (pollVal / 2); }
      data.push(entry);
    }
  }
  return data;
}

/* â•â•â•â•â•â•â•â•â•â•â• VISUALIZATION â•â•â•â•â•â•â•â•â•â•â• */

function updateStatsDual(id, count, s1MA, s2MA) {
  const container = $(id);
  if (!container) return;

  const box1 = container.children[0].children[1];
  const box2 = container.children[1].children[1];
  // Net box is index 2
  const box3 = container.children[2].children[1];
  const box4 = container.children[3].children[1];

  const latest1 = s1MA.length ? s1MA[s1MA.length - 1].value : null;
  const latest2 = s2MA.length ? s2MA[s2MA.length - 1].value : null;

  if (latest1 !== null) {
    box1.innerHTML = `${latest1.toFixed(1)}% ${getTrendHTML(s1MA)}`;
    box1.style.color = id === 'gbStats' ? 'var(--dem-blue)' : 'var(--approve-green)';
  } else box1.textContent = "â€”";

  if (latest2 !== null) {
    box2.innerHTML = `${latest2.toFixed(1)}% ${getTrendHTML(s2MA)}`;
    box2.style.color = 'var(--rep-red)';
  } else box2.textContent = "â€”";

  // Net / Margin
  if (latest1 !== null && latest2 !== null) {
    const net = latest1 - latest2;
    const sign = net > 0 ? '+' : '';
    if (id === 'gbStats') {
      const label = net > 0 ? 'D' : net < 0 ? 'R' : '';
      box3.innerHTML = `<span style="color: ${net >= 0 ? 'var(--dem-blue)' : 'var(--rep-red)'}">${label}${sign}${net.toFixed(1)}</span>`;
    } else {
      box3.innerHTML = `<span style="color: ${net >= 0 ? 'var(--approve-green)' : 'var(--rep-red)'}">${sign}${net.toFixed(1)}</span>`;
    }
  } else box3.textContent = "â€”";

  box4.textContent = count;
}

function updateHeadlines(apData, gbData, apPrimary, gbPrimary) {
  const banner = $('headlineBanner');

  const mapVal = (arr, key) => arr.map(p => ({ ...p, value: p[key] })).filter(p => p.value != null);
  const maFor = (which, raw) => {
    const cfg = CUSTOM[which];
    if (cfg.autoMin) return calculateRollingAvgMinPolls(raw, cfg.minPolls);
    return calculateRollingAvg(raw, cfg.maDays);
  };

  // Approval headline
  const appRaw = mapVal(apPrimary, 'approve');
  const disRaw = mapVal(apPrimary, 'disapprove');
  const appMA = maFor('approval', appRaw);
  const disMA = maFor('approval', disRaw);

  const latApp = appMA.length ? appMA[appMA.length - 1].value : null;
  const latDis = disMA.length ? disMA[disMA.length - 1].value : null;

  if (latApp !== null) $('hlApprove').textContent = latApp.toFixed(1) + '%';
  if (latDis !== null) $('hlDisapprove').textContent = latDis.toFixed(1) + '%';

  if (latApp !== null && latDis !== null) {
    const net = latApp - latDis;
    const sign = net > 0 ? '+' : '';
    const el = $('hlApprovalNet');
    el.textContent = `Net ${sign}${net.toFixed(1)}`;
    el.style.color = net >= 0 ? 'var(--approve-green)' : 'var(--disapprove-orange)';
    el.style.background = net >= 0 ? 'var(--approve-green-light)' : 'var(--disapprove-orange-light)';
  }
  $('hlApprovalTrend').innerHTML = getTrendBadge(appMA);
  $('hlApprovalPolls').textContent = `${apPrimary.length} polls`;

  // GB headline
  const demRaw = mapVal(gbPrimary, 'dem');
  const repRaw = mapVal(gbPrimary, 'rep');
  const demMA = maFor('gb', demRaw);
  const repMA = maFor('gb', repRaw);

  const latDem = demMA.length ? demMA[demMA.length - 1].value : null;
  const latRep = repMA.length ? repMA[repMA.length - 1].value : null;

  if (latDem !== null) $('hlDem').textContent = latDem.toFixed(1) + '%';
  if (latRep !== null) $('hlRep').textContent = latRep.toFixed(1) + '%';

  if (latDem !== null && latRep !== null) {
    const margin = latDem - latRep;
    const label = margin > 0 ? 'D' : margin < 0 ? 'R' : '';
    const sign = margin > 0 ? '+' : '';
    const el = $('hlGBNet');
    el.textContent = `${label}${sign}${margin.toFixed(1)}`;
    el.style.color = margin >= 0 ? 'var(--dem-blue)' : 'var(--rep-red)';
    el.style.background = margin >= 0 ? 'var(--dem-blue-light)' : 'var(--rep-red-light)';
  }
  $('hlGBTrend').innerHTML = getTrendBadge(demMA);
  $('hlGBPolls').textContent = `${gbPrimary.length} polls`;

  banner.style.display = 'grid';
}

/* â•â•â•â•â•â•â•â•â•â•â• PLOTLY CHARTS â•â•â•â•â•â•â•â•â•â•â• */

function getPlotlyTheme() {
  const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  return {
    gridColor: isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)',
    textColor: isDark ? '#888' : '#999',
    spikeColor: isDark ? '#444' : '#ccc',
    isDark
  };
}

function renderDualChart(divId, datasets, yTitle) {
  const traces = [];
  const theme = getPlotlyTheme();

  datasets.forEach(ds => {
    const rawOpacity = ds.rawOpacity ?? 0.3;
    if (ds.raw && ds.raw.length) {
      traces.push({
        x: ds.raw.map(p => p.date),
        y: ds.raw.map(p => p.value),
        mode: 'markers',
        type: 'scatter',
        name: ds.name + ' (Polls)',
        marker: {
          color: ds.color,
          opacity: rawOpacity,
          size: 5.5,
          symbol: ds.markerSymbol || 'circle',
          line: { width: 0 }
        },
        text: ds.raw.map(p =>
          `<b>${p.pollster}</b><br>${p.date.toISOString().slice(0,10)}<br>${ds.name}: ${p.value.toFixed(1)}%<br>N=${p.sample_size}`
        ),
        hovertemplate: '%{text}<extra></extra>',
        showlegend: false
      });
    }
    if (ds.ma && ds.ma.length) {
      traces.push({
        x: ds.ma.map(p => p.date),
        y: ds.ma.map(p => p.value),
        mode: 'lines',
        name: ds.name,
        line: { color: ds.color, width: ds.lineWidth || 3, dash: ds.lineDash || 'solid', shape: 'spline', smoothing: 1.2 },
        customdata: ds.ma.map(p => [p.count ?? null, p.windowDays ?? ds.windowDays ?? null]),
        hovertemplate:
          `<b>${ds.name}</b><br>%{x|%b %d, %Y}<br>` +
          `Value: %{y:.1f}%<br>Polls: %{customdata[0]}<br>Window: %{customdata[1]}d<extra></extra>`
      });
    }
  });

  const layout = {
    autosize: true,
    margin: { t: 16, r: 16, l: 44, b: 44 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'DM Sans, sans-serif', color: theme.textColor, size: 12 },
    xaxis: {
      gridcolor: theme.gridColor,
      zerolinecolor: theme.gridColor,
      tickformat: '%b %Y',
      showspikes: true,
      spikemode: 'across',
      spikethickness: 1,
      spikecolor: theme.spikeColor,
      spikedash: 'solid',
      spikesnap: 'cursor',
      tickfont: { family: 'DM Sans, sans-serif', size: 11 }
    },
    yaxis: {
      title: { text: yTitle, font: { size: 11, color: theme.textColor } },
      gridcolor: theme.gridColor,
      zeroline: false,
      tickfont: { family: 'JetBrains Mono, monospace', size: 11 },
      ticksuffix: '%'
    },
    showlegend: true,
    legend: { orientation: 'h', y: 1.1, x: 0, font: { size: 11 } },
    hovermode: 'closest',
    dragmode: 'pan',
    hoverlabel: {
      bgcolor: theme.isDark ? '#1f1f23' : '#fff',
      bordercolor: theme.isDark ? '#333' : '#ddd',
      font: { family: 'DM Sans, sans-serif', size: 12, color: theme.isDark ? '#eee' : '#333' }
    }
  };

  Plotly.react(divId, traces, layout, { responsive: true, displayModeBar: false, scrollZoom: false });
}

function renderDiffChart(divId, seriesList, yTitle) {
  const theme = getPlotlyTheme();
  const traces = seriesList.map(s => ({
    x: (s.series || []).map(p => p.date),
    y: (s.series || []).map(p => p.value),
    mode: 'lines',
    type: 'scatter',
    name: s.name,
    line: { color: s.color, width: 2, shape: 'spline', smoothing: 1.2 },
    customdata: (s.series || []).map(p => [p.countA ?? null, p.countB ?? null]),
    hovertemplate:
      `<b>${s.name}</b><br>%{x|%b %d, %Y}<br>` +
      `Î”: %{y:.2f}pp<br>Polls (filtered/all): %{customdata[0]}/%{customdata[1]}<extra></extra>`
  }));

  const layout = {
    autosize: true,
    margin: { t: 12, r: 16, l: 44, b: 36 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'DM Sans, sans-serif', color: theme.textColor, size: 12 },
    xaxis: {
      gridcolor: theme.gridColor,
      zerolinecolor: theme.gridColor,
      tickformat: '%b %Y',
      showspikes: true, spikemode: 'across', spikethickness: 1,
      spikecolor: theme.spikeColor, spikedash: 'solid', spikesnap: 'cursor'
    },
    yaxis: {
      title: { text: yTitle, font: { size: 11, color: theme.textColor } },
      gridcolor: theme.gridColor,
      zeroline: true, zerolinecolor: theme.gridColor,
      tickfont: { family: 'JetBrains Mono, monospace', size: 11 }
    },
    showlegend: true,
    legend: { orientation: 'h', y: 1.15, x: 0, font: { size: 11 } },
    hovermode: 'closest',
    dragmode: 'pan'
  };

  Plotly.react(divId, traces, layout, { responsive: true, displayModeBar: false, scrollZoom: false });
}

/* â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â• */

const app = {
  async init() {
    $('loadingIndicator').style.display = 'block';

    // Render pollster tags
    $('pollsterList').innerHTML = ALLOWED_POLLSTERS.map(p =>
      `<span class="pollster-tag">${p.label}</span>`
    ).join("");

    try {
      const candidates = [
        new URL('polls.json', window.location.href).href,
        './polls.json', 'polls.json', '../polls.json'
      ];
      let res = null, usedUrl = null, lastErr = null;
      for (const u of candidates) {
        try {
          const r = await fetch(u, { cache: 'no-store' });
          if (r && r.ok) { res = r; usedUrl = u; break; }
        } catch (e) { lastErr = e; }
      }
      if (!res) throw (lastErr || new Error('Could not load polls.json'));
      if (!res.ok) throw new Error("Could not load local data file.");

      const json = await res.json();
      const gbList = json.genericBallot || json.polls || [];
      const appList = json.approval || [];
      if (gbList.length === 0 && appList.length === 0) throw new Error("JSON file was empty.");

      STATE.gbData = this.normalizeGB(gbList);
      STATE.approvalData = this.normalizeApproval(appList);

      if (json.updatedAt || json.updated_at) {
        const dateStr = json.updatedAt || json.updated_at;
        const date = new Date(dateStr).toLocaleString();
        showStatus(`Data updated: ${date}`, "success");
      } else {
        showStatus("Data loaded successfully.", "success");
      }
    } catch (e) {
      console.warn("Local load failed, falling back to Demo", e);
      STATE.isDemoMode = true;
      showStatus("Could not find polls.json â€” using demo data.", "warn");
      STATE.gbData = generateMockData('gb');
      STATE.approvalData = generateMockData('approval');
    }

    $('loadingIndicator').style.display = 'none';
    this.initCustomControls();
    this.refreshViews();

    window.addEventListener('resize', () => {
      ['gbChart','approvalChart','gbDiffChart','approvalDiffChart'].forEach(id => {
        try { if ($(id)) Plotly.Plots.resize(id); } catch(e) {}
      });
    });

    // Re-render on theme change
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      this.refreshViews();
    });
  },

  toggleCustomize(which) {
    const panel = $(which + 'CustomizePanel');
    if (!panel) return;
    const isOpen = panel.style.display !== 'none';
    panel.style.display = isOpen ? 'none' : 'block';
  },

  initCustomControls() {
    const setup = (which, defaults) => {
      const days = $(which + 'MADays');
      const daysRange = $(which + 'MADaysRange');
      const auto = $(which + 'AutoMin');
      const minPolls = $(which + 'MinPolls');
      const compare = $(which + 'Compare');
      const showDiff = $(which + 'ShowDiff');
      if (!days || !daysRange || !auto || !minPolls || !compare || !showDiff) return;

      CUSTOM[which].maDays = defaults.maDays;
      CUSTOM[which].autoMin = defaults.autoMin;
      CUSTOM[which].minPolls = defaults.minPolls;
      CUSTOM[which].compare = defaults.compare;
      CUSTOM[which].showDiff = defaults.showDiff;

      days.value = CUSTOM[which].maDays;
      daysRange.value = Math.min(parseInt(daysRange.max || '365', 10), CUSTOM[which].maDays);
      auto.checked = CUSTOM[which].autoMin;
      minPolls.value = CUSTOM[which].minPolls;
      compare.checked = CUSTOM[which].compare;
      showDiff.checked = CUSTOM[which].showDiff;

      const syncDisabled = () => {
        const isAuto = auto.checked;
        days.disabled = isAuto;
        daysRange.disabled = isAuto;
        minPolls.disabled = !isAuto;
        showDiff.disabled = !compare.checked;
        if (!compare.checked) showDiff.checked = false;
        CUSTOM[which].autoMin = auto.checked;
        CUSTOM[which].minPolls = parseInt(minPolls.value || defaults.minPolls, 10);
        CUSTOM[which].compare = compare.checked;
        CUSTOM[which].showDiff = showDiff.checked;
        CUSTOM[which].maDays = parseInt(days.value || defaults.maDays, 10);
      };

      const applyAndRefresh = () => {
        const d = Math.max(3, parseInt(days.value || defaults.maDays, 10));
        days.value = d;
        daysRange.value = Math.min(parseInt(daysRange.max || '365', 10), d);
        const mp = Math.max(3, parseInt(minPolls.value || defaults.minPolls, 10));
        minPolls.value = mp;
        syncDisabled();
        app.refreshViews();
      };

      daysRange.addEventListener('input', () => { days.value = daysRange.value; applyAndRefresh(); });
      days.addEventListener('change', applyAndRefresh);
      auto.addEventListener('change', applyAndRefresh);
      minPolls.addEventListener('change', applyAndRefresh);
      compare.addEventListener('change', applyAndRefresh);
      showDiff.addEventListener('change', applyAndRefresh);
      syncDisabled();
    };

    setup('approval', { maDays: CONFIG.approvalWindow, autoMin: true, minPolls: 24, compare: false, showDiff: false });
    setup('gb',       { maDays: CONFIG.gbWindow,       autoMin: true, minPolls: 24, compare: false, showDiff: false });
  },

  normalizeGB(list) {
    return list.map(p => {
      const dem = getAnswer(p, ['Dem', 'Democrat']);
      const rep = getAnswer(p, ['Rep', 'Republican']);
      if (dem === null || rep === null) return null;
      return { date: parseDate(p.end_date || p.start_date), dem, rep, pollster: p.pollster, sample_size: p.sample_size };
    }).filter(x => x);
  },

  normalizeApproval(list) {
    return list.map(p => {
      const app = getAnswer(p, ['Approve', 'Strongly Approve', 'Yes']);
      const dis = getAnswer(p, ['Disapprove', 'Strongly Disapprove', 'No']);
      if (app === null && dis === null) return null;
      return { date: parseDate(p.end_date || p.start_date), approve: app, disapprove: dis, pollster: p.pollster, sample_size: p.sample_size };
    }).filter(x => x);
  },

  refreshViews() {
    STATE.filterStrict = $('toggleFilter').checked;
    const badge = $('filterModeBadge');
    const modeText = $('filterModeText');
    const labelText = $('filterLabelText');

    if (STATE.filterStrict) {
      modeText.textContent = "Strict Allowlist";
      badge.className = "filter-mode-badge strict";
      labelText.textContent = "Quality Filter";
    } else {
      modeText.textContent = "All Sources";
      badge.className = "filter-mode-badge all";
      labelText.textContent = "All Sources";
    }

    const gbStrict = STATE.gbData.filter(p => isAllowed(p.pollster, true));
    const gbAll = STATE.gbData.slice();
    const apStrict = STATE.approvalData.filter(p => isAllowed(p.pollster, true));
    const apAll = STATE.approvalData.slice();

    const gbPrimary = STATE.filterStrict ? gbStrict : gbAll;
    const apPrimary = STATE.filterStrict ? apStrict : apAll;

    const mapVal = (arr, key) => arr.map(p => ({ ...p, value: p[key] })).filter(p => p.value != null);

    const maFor = (which, raw) => {
      const cfg = CUSTOM[which];
      if (cfg.autoMin) return calculateRollingAvgMinPolls(raw, cfg.minPolls);
      return calculateRollingAvg(raw, cfg.maDays);
    };

    // Update headline banner
    updateHeadlines(STATE.approvalData, STATE.gbData, apPrimary, gbPrimary);

    /* â”€â”€â”€â”€ Generic Ballot â”€â”€â”€â”€ */
    {
      const cfg = CUSTOM.gb;
      const demRawP = mapVal(gbPrimary, 'dem');
      const repRawP = mapVal(gbPrimary, 'rep');
      const demMAP = maFor('gb', demRawP);
      const repMAP = maFor('gb', repRawP);
      updateStatsDual('gbStats', gbPrimary.length, demMAP, repMAP);

      let datasets = [
        { name: 'Democrats', raw: demRawP, ma: demMAP, color: getComputedStyle(document.documentElement).getPropertyValue('--dem-blue').trim(), lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
        { name: 'Republicans', raw: repRawP, ma: repMAP, color: getComputedStyle(document.documentElement).getPropertyValue('--rep-red').trim(), lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays }
      ];

      const diffEl = $('gbDiffChart');

      if (cfg.compare) {
        const demRawF = mapVal(gbStrict, 'dem'), repRawF = mapVal(gbStrict, 'rep');
        const demMAF = maFor('gb', demRawF), repMAF = maFor('gb', repRawF);
        const demRawA = mapVal(gbAll, 'dem'), repRawA = mapVal(gbAll, 'rep');
        const demMAA = maFor('gb', demRawA), repMAA = maFor('gb', repRawA);

        const demColor = getComputedStyle(document.documentElement).getPropertyValue('--dem-blue').trim();
        const repColor = getComputedStyle(document.documentElement).getPropertyValue('--rep-red').trim();

        datasets = [
          { name: 'Dem (Filtered)', raw: demRawF, ma: demMAF, color: demColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
          { name: 'Rep (Filtered)', raw: repRawF, ma: repMAF, color: repColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
          { name: 'Dem (All)', raw: demRawA, ma: demMAA, color: demColor, lineDash: 'dot', rawOpacity: 0.12, windowDays: cfg.maDays, lineWidth: 2 },
          { name: 'Rep (All)', raw: repRawA, ma: repMAA, color: repColor, lineDash: 'dot', rawOpacity: 0.12, windowDays: cfg.maDays, lineWidth: 2 }
        ];

        if (cfg.showDiff) {
          diffEl.style.display = 'block';
          renderDiffChart('gbDiffChart', [
            { name: 'Dem Î”', color: demColor, series: diffSeries(demMAF, demMAA) },
            { name: 'Rep Î”', color: repColor, series: diffSeries(repMAF, repMAA) }
          ], 'Filtered âˆ’ All (pp)');
        } else { diffEl.style.display = 'none'; }
      } else { diffEl.style.display = 'none'; }

      renderDualChart('gbChart', datasets, '');
    }

    /* â”€â”€â”€â”€ Approval â”€â”€â”€â”€ */
    {
      const cfg = CUSTOM.approval;
      const appRawP = mapVal(apPrimary, 'approve');
      const disRawP = mapVal(apPrimary, 'disapprove');
      const appMAP = maFor('approval', appRawP);
      const disMAP = maFor('approval', disRawP);
      updateStatsDual('approvalStats', apPrimary.length, appMAP, disMAP);

      const approveColor = getComputedStyle(document.documentElement).getPropertyValue('--approve-green').trim();
      const disapproveColor = getComputedStyle(document.documentElement).getPropertyValue('--disapprove-orange').trim();

      let datasets = [
        { name: 'Approve', raw: appRawP, ma: appMAP, color: approveColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
        { name: 'Disapprove', raw: disRawP, ma: disMAP, color: disapproveColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays }
      ];

      const diffEl = $('approvalDiffChart');

      if (cfg.compare) {
        const appRawF = mapVal(apStrict, 'approve'), disRawF = mapVal(apStrict, 'disapprove');
        const appMAF = maFor('approval', appRawF), disMAF = maFor('approval', disRawF);
        const appRawA = mapVal(apAll, 'approve'), disRawA = mapVal(apAll, 'disapprove');
        const appMAA = maFor('approval', appRawA), disMAA = maFor('approval', disRawA);

        datasets = [
          { name: 'Approve (Filtered)', raw: appRawF, ma: appMAF, color: approveColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
          { name: 'Disapprove (Filtered)', raw: disRawF, ma: disMAF, color: disapproveColor, lineDash: 'solid', rawOpacity: 0.25, windowDays: cfg.maDays },
          { name: 'Approve (All)', raw: appRawA, ma: appMAA, color: approveColor, lineDash: 'dot', rawOpacity: 0.12, windowDays: cfg.maDays, lineWidth: 2 },
          { name: 'Disapprove (All)', raw: disRawA, ma: disMAA, color: disapproveColor, lineDash: 'dot', rawOpacity: 0.12, windowDays: cfg.maDays, lineWidth: 2 }
        ];

        if (cfg.showDiff) {
          diffEl.style.display = 'block';
          renderDiffChart('approvalDiffChart', [
            { name: 'Approve Î”', color: approveColor, series: diffSeries(appMAF, appMAA) },
            { name: 'Disapprove Î”', color: disapproveColor, series: diffSeries(disMAF, disMAA) }
          ], 'Filtered âˆ’ All (pp)');
        } else { diffEl.style.display = 'none'; }
      } else { diffEl.style.display = 'none'; }

      renderDualChart('approvalChart', datasets, '');
    }
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => app.init());
} else {
  app.init();
}
</script>
</body>
</html>
