<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Polls</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‡ºðŸ‡¸</text></svg>">
  
  <!-- Load Plotly from CDN -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  
  <style>
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      
      /* Brand Colors */
      --primary: #2563eb;   /* Dem Blue */
      --danger: #dc2626;    /* Rep Red */
      --success: #16a34a;   /* Approve Green */
      --neutral: #475569;
    }

    /* Dark Mode Overrides */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #020617;
        --bg-card: #1e293b;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: #334155;
        --primary: #60a5fa;
        --danger: #f87171;
        --success: #4ade80;
      }
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      background-color: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 800;
      letter-spacing: -0.025em;
      color: var(--text-main);
    }

    header .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 1.25rem;
      align-items: center;
      font-size: 0.875rem;
    }

    label.toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: var(--text-main);
    }

    label.toggle input {
      accent-color: var(--primary);
      width: 1rem;
      height: 1rem;
      margin-right: 0.5rem;
    }

    /* Layout */
    main {
      padding: 2rem 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Cards */
    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s;
    }
    
    .card:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      margin: 0 0 1.25rem 0;
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Charts */
    .plot-container {
      width: 100%;
      height: 450px;
      position: relative;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    /* Stats Grid */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-box {
      background: var(--bg-body);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .stat-label { 
      font-size: 0.7rem; 
      color: var(--text-muted); 
      text-transform: uppercase; 
      letter-spacing: 0.05em; 
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .stat-value { 
      font-size: 1.5rem; 
      font-weight: 700; 
      line-height: 1.2;
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .trend-indicator {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.1rem 0.4rem;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
    }
    .trend-up { color: var(--success); background: rgba(22, 163, 74, 0.1); }
    .trend-down { color: var(--danger); background: rgba(220, 38, 38, 0.1); }
    .trend-flat { color: var(--text-muted); background: rgba(148, 163, 184, 0.1); }

    /* Footer */
    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
      border-top: 1px solid var(--border);
      background: var(--bg-card);
      margin-top: auto;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    #pollsterList {
      max-height: 120px;
      overflow-y: auto;
      padding: 0.75rem;
      background: var(--bg-body);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.125rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    .alert.info { background: rgba(37, 99, 235, 0.1); color: var(--primary); border: 1px solid rgba(37, 99, 235, 0.2); }
    .alert.error { background: rgba(220, 38, 38, 0.1); color: var(--danger); border: 1px solid rgba(220, 38, 38, 0.2); }
    .alert.warn { background: rgba(245, 158, 11, 0.1); color: #b45309; border: 1px solid rgba(245, 158, 11, 0.2); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Loading Spinner */
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    #debugCard { display: none; margin-top: 2rem; }
    #debugOut { background: #000; color: #0f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }

  </style>
</head>

<body>

  <header>
    <div>
      <h1>Polls</h1>
      <div class="subtitle">Polling Aggregation powered by VoteHub</div>
    </div>
    <div class="controls">
      <div id="loadingIndicator" style="display:none; color: var(--primary);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
      </div>
      <label class="toggle" title="Toggle between a strict quality filter and all data">
        <input type="checkbox" id="toggleFilter" checked onchange="app.refreshViews()">
        <span>Filter</span>
      </label>
    </div>
  </header>

  <main>
    <div id="globalStatus" class="alert info">Initializing...</div>

    <!-- Generic Ballot Card -->
    <div class="card">
      <h2>
        Generic Ballot
        <span class="small" style="font-weight: 400;">Dem vs Rep</span>
      </h2>
      
      <div class="stats-row" id="gbStats">
        <div class="stat-box">
          <div class="stat-label">Democratic Avg</div>
          <div class="stat-value">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Republican Avg</div>
          <div class="stat-value">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Polls</div>
          <div class="stat-value">--</div>
        </div>
      </div>

      <div id="gbChart" class="plot-container"></div>
      <div class="small" style="margin-top: 0.5rem">
        Hover over dots to see poll details. Hover over chart area to track trends.
      </div>
    </div>

    <!-- Approval Card -->
    <div class="card">
      <h2>
        Presidential Approval
        <span class="small" style="font-weight: 400;">Approve vs Disapprove</span>
      </h2>
      
      <div class="stats-row" id="approvalStats">
        <div class="stat-box">
          <div class="stat-label">Approve Avg</div>
          <div class="stat-value">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Disapprove Avg</div>
          <div class="stat-value">--</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Polls</div>
          <div class="stat-value">--</div>
        </div>
      </div>

      <div id="approvalChart" class="plot-container"></div>
      <div class="small" style="margin-top: 0.5rem">
        Includes "Strongly" variations where available.
      </div>
    </div>

    <div class="card">
      <h2>Pollster Inclusion</h2>
      <div class="small">
        <strong>Current Mode:</strong> <span id="filterModeText">Strict Allowlist</span>
        <br>
        Showing polls from the following sources:
      </div>
      <div id="pollsterList"></div>
    </div>

    <div class="card" id="debugCard">
      <h2>Debug Log</h2>
      <pre id="debugOut" class="small"></pre>
    </div>
  </main>

  <footer>
    <p>VoteHub Dashboard &copy; <span id="year"></span>. Data aggregated from public polling sources.</p>
    <p class="small">Disclaimer: Polls are snapshots in time. Rolling averages may lag behind breaking news.</p>
  </footer>

<script>
/**
 * VoteHub Dashboard - Enhanced v3
 * Updates: 'closest' hover mode + spikelines for better scrubbing experience
 */

const CONFIG = {
  apiBase: "https://api.votehub.com/polls",
  lookbackDays: 400,
  approvalWindow: 14,
  gbWindow: 30,
  proxyPrefix: "https://r.jina.ai/http://",
  debug: new URLSearchParams(location.search).has("debug")
};

document.getElementById("year").textContent = new Date().getFullYear();

// State
const STATE = {
  approvalData: [],
  gbData: [],
  isDemoMode: false,
  filterStrict: true
};

/* -------------------- Pollster Allowlist -------------------- */
const ALLOWED_POLLSTERS = [
  { label: "YouGov", pattern: /yougov/ },
  { label: "Ipsos", pattern: /ipsos/ },
  { label: "ARG", pattern: /americanresearchgroup|arg\b/ },
  { label: "TIPP", pattern: /tipp/ },
  { label: "Emerson", pattern: /emerson/ },
  { label: "Gallup", pattern: /gallup/ },
  { label: "Marist", pattern: /marist/ },
  { label: "Quinnipiac", pattern: /quinnipiac/ },
  { label: "AP-NORC", pattern: /apnorc|ap\-norc|norc/ },
  { label: "Marquette", pattern: /marquette/ },
  { label: "CNN/SSRS", pattern: /cnnssrs|cnn\/ssrs|ssrs/ },
  { label: "AtlasIntel", pattern: /atlasintel|atlas/ },
  { label: "Beacon/Shaw", pattern: /beaconresearch|shaw/ },
  { label: "Hart/POS", pattern: /hartresearch|publicopinionstrategies/ },
  { label: "Pew", pattern: /pewresearch|pew/ },
  { label: "SurveyMonkey", pattern: /surveymonkey/ },
  { label: "Leger", pattern: /leger/ },
  { label: "UMass", pattern: /massachusetts|umass|departmentofpoliticalscience/ },
  { label: "NYT/Siena", pattern: /siena|newyorktimes/ },
  { label: "Fox News", pattern: /foxnews/ },
  { label: "WSJ", pattern: /wallstreetjournal|wsj/ },
];

/* -------------------- Utilities -------------------- */
const $ = (id) => document.getElementById(id);

function log(msg) {
  if(CONFIG.debug) {
    $('debugCard').style.display = 'block';
    $('debugOut').textContent += `[${new Date().toISOString().slice(11,19)}] ${msg}\n`;
  }
}

function showStatus(msg, type = 'info') {
  const el = $('globalStatus');
  el.textContent = msg;
  el.className = `alert ${type}`;
  el.style.display = 'block';
  // Auto hide success messages after 5s
  if(type === 'success') setTimeout(() => el.style.display = 'none', 5000);
}

function norm(s) {
  return String(s || "").toLowerCase().replace(/&/g, "and").replace(/[^a-z0-9]+/g, "");
}

function isAllowed(pollsterName) {
  if (!STATE.filterStrict) return true;
  const n = norm(pollsterName);
  return ALLOWED_POLLSTERS.some(x => x.pattern.test(n));
}

function parseDate(s) {
  return new Date(`${s}T00:00:00Z`);
}

/* -------------------- Math & Logic -------------------- */

// Calculate Simple Moving Average (SMA)
function calculateRollingAvg(points, windowDays) {
  if (!points.length) return [];
  const sorted = points.slice().sort((a, b) => a.date - b.date);
  const msPerDay = 86400000;
  
  const output = [];
  const startTs = sorted[0].date.getTime();
  const endTs = sorted[sorted.length - 1].date.getTime();

  for (let t = startTs; t <= endTs; t += msPerDay) {
    const currentDay = new Date(t);
    const windowStart = t - (windowDays * msPerDay);
    
    const inWindow = sorted.filter(p => {
      const pts = p.date.getTime();
      return pts > windowStart && pts <= t;
    });

    if (inWindow.length > 0) {
      const avg = inWindow.reduce((acc, p) => acc + p.value, 0) / inWindow.length;
      output.push({ date: currentDay, value: avg, count: inWindow.length });
    }
  }
  return output;
}

function getAnswer(poll, keys) {
  if(!poll.answers) return null;
  for (const ans of poll.answers) {
    const c = norm(ans.choice);
    // Avoid false positives (e.g. "Disapprove" contains "Approve")
    if (c.includes('disapprove') && keys.some(k => norm(k).includes('approve') && !norm(k).includes('dis'))) {
        continue;
    }
    for (const key of keys) {
      if (c.includes(norm(key))) return parseFloat(ans.pct);
    }
  }
  return null;
}

// Calculate trend (change over last 7 days of data points)
function getTrendHTML(series) {
  if (series.length < 2) return '';
  
  const current = series[series.length - 1].value;
  // Look back ~7 indices (assuming daily points) or fallback to start
  const lookbackIndex = Math.max(0, series.length - 8); 
  const past = series[lookbackIndex].value;
  const diff = current - past;
  
  let arrow, cls;
  if (diff > 0.5) { arrow = 'â†‘'; cls = 'trend-up'; }
  else if (diff < -0.5) { arrow = 'â†“'; cls = 'trend-down'; }
  else { arrow = 'â†’'; cls = 'trend-flat'; }
  
  return `<span class="trend-indicator ${cls}" title="${diff > 0 ? '+' : ''}${diff.toFixed(1)} since last week">${arrow}</span>`;
}

/* -------------------- Mock Data (Fallback) -------------------- */
function generateMockData(type) {
  const data = [];
  const pollsters = ALLOWED_POLLSTERS.map(p => p.label).concat(["Unknown Polling", "Generic Analytics"]);
  const now = new Date();
  let value = type === 'approval' ? 42 : 2; 
  
  for (let i = 365; i >= 0; i--) {
    const date = new Date(now.getTime() - i * 86400000);
    value += (Math.random() - 0.5) * 1.5; 
    const pollsToday = Math.floor(Math.random() * 2.5); 
    
    for (let j = 0; j < pollsToday; j++) {
      const variance = (Math.random() - 0.5) * 6;
      const pollVal = value + variance;
      const pollster = pollsters[Math.floor(Math.random() * pollsters.length)];
      
      let entry = {
        date: date,
        pollster: pollster,
        sample_size: 500 + Math.floor(Math.random() * 1000),
        url: "#"
      };

      if (type === 'approval') {
        entry.approve = pollVal;
        entry.disapprove = 100 - pollVal - 5; 
      } else {
        const dem = 46 + (pollVal / 2);
        const rep = 46 - (pollVal / 2);
        entry.dem = dem;
        entry.rep = rep;
      }
      data.push(entry);
    }
  }
  return data;
}

/* -------------------- API Fetching -------------------- */

async function fetchWithTimeout(url) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), 12000);
  try {
    const response = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    return response;
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
}

async function fetchPolls(type, extraParams = {}) {
  const now = new Date();
  const fromDate = new Date(now.getTime() - CONFIG.lookbackDays * 86400000).toISOString().split('T')[0];
  
  const params = new URLSearchParams({
    poll_type: type,
    from_date: fromDate,
    sort: "-end_date"
  });

  for (const [key, value] of Object.entries(extraParams)) {
    params.set(key, value);
  }

  const url = `${CONFIG.apiBase}?${params.toString()}`;
  const candidates = [
    url,
    `${CONFIG.proxyPrefix}${url.replace(/^https?:\/\//, '')}`
  ];

  for (const uri of candidates) {
    try {
      log(`Fetching: ${uri}`);
      const res = await fetchWithTimeout(uri);
      if (!res.ok) throw new Error(`Status ${res.status}`);
      
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } 
      catch (e) {
        // Fallback for messy proxy responses
        const start = text.indexOf('[');
        const end = text.lastIndexOf(']');
        if (start > -1 && end > start) {
          json = JSON.parse(text.substring(start, end+1));
        } else { throw e; }
      }
      
      const list = Array.isArray(json) ? json : (json.polls || []);
      if(list.length > 0) return list;
      
    } catch (e) {
      log(`Failed ${uri}: ${e.message}`);
    }
  }
  throw new Error("All fetch attempts failed");
}

/* -------------------- Visualization -------------------- */

function updateStatsDual(id, count, s1MA, s2MA) {
  const container = $(id);
  if (!container) return;

  const box1 = container.children[0].children[1];
  const box2 = container.children[1].children[1];
  const box3 = container.children[2].children[1];

  const latest1 = s1MA.length ? s1MA[s1MA.length-1].value : null;
  const latest2 = s2MA.length ? s2MA[s2MA.length-1].value : null;

  // Render Value + Trend Arrow
  if (latest1 !== null) {
    box1.innerHTML = `${latest1.toFixed(1)}% ${getTrendHTML(s1MA)}`;
    box1.style.color = id === 'gbStats' ? 'var(--primary)' : 'var(--success)';
  } else box1.textContent = "--";

  if (latest2 !== null) {
    box2.innerHTML = `${latest2.toFixed(1)}% ${getTrendHTML(s2MA)}`;
    box2.style.color = 'var(--danger)';
  } else box2.textContent = "--";

  box3.textContent = count;
}

function renderDualChart(divId, datasets, yTitle) {
  const traces = [];

  datasets.forEach(ds => {
    // 1. Scatter (Individual Polls)
    traces.push({
      x: ds.raw.map(p => p.date),
      y: ds.raw.map(p => p.value),
      mode: 'markers',
      type: 'scatter',
      name: ds.name + ' (Polls)',
      marker: { 
        color: ds.color,
        opacity: 0.35,
        size: 7,
        line: { width: 1, color: '#fff' }
      },
      text: ds.raw.map(p => 
        `<b>${p.pollster}</b><br>${p.date.toISOString().slice(0,10)}<br>${ds.name}: ${p.value.toFixed(1)}%<br>N=${p.sample_size}`
      ),
      hovertemplate: '%{text}<extra></extra>',
      showlegend: false
    });

    // 2. Line (Rolling Average)
    traces.push({
      x: ds.ma.map(p => p.date),
      y: ds.ma.map(p => p.value),
      mode: 'lines',
      name: ds.name, 
      line: { color: ds.color, width: 3 },
      // Updated tooltip for Line
      hovertemplate: `<b>${ds.name} (Avg)</b><br>%{x|%Y-%m-%d}<br>Value: %{y:.1f}%<extra></extra>`
    });
  });

  const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const gridColor = isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)';
  const textColor = isDark ? '#94a3b8' : '#64748b';
  const spikeColor = isDark ? '#475569' : '#94a3b8';

  const layout = {
    autosize: true,
    margin: { t: 20, r: 20, l: 40, b: 40 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'inherit', color: textColor },
    xaxis: { 
      gridcolor: gridColor,
      zerolinecolor: gridColor,
      tickformat: '%b %Y',
      // Spikeline configuration
      showspikes: true,
      spikemode: 'across',
      spikethickness: 1,
      spikecolor: spikeColor,
      spikedash: 'solid',
      spikesnap: 'cursor' // Snaps line to cursor x-position
    },
    yaxis: { 
      title: yTitle, 
      gridcolor: gridColor,
      zeroline: false
    },
    showlegend: true,
    legend: { orientation: 'h', y: 1.1, x: 0 },
    // Changed from 'x unified' to 'closest'
    hovermode: 'closest',
    dragmode: 'pan' 
  };

  const config = { 
    responsive: true, 
    displayModeBar: false, 
    scrollZoom: false 
  };

  Plotly.react(divId, traces, layout, config);
}

/* -------------------- Main App -------------------- */

const app = {
  async init() {
    $('loadingIndicator').style.display = 'block';
    
    // Render Pollster Tags
    $('pollsterList').innerHTML = ALLOWED_POLLSTERS.map(p => 
      `<span class="tag">${p.label}</span>`
    ).join(" ");

    try {
      // 1. Generic Ballot
      try {
        const gbRaw = await fetchPolls('generic-ballot');
        STATE.gbData = this.normalizeGB(gbRaw);
      } catch (e) {
        log(`GB Fail: ${e}`);
        STATE.gbData = [];
      }

      // 2. Approval
      try {
        const subjects = ['donald-trump', 'trump', 'joe-biden', 'biden'];
        let appRaw = [];
        for (const subj of subjects) {
            try {
                log(`Trying approval: ${subj}`);
                appRaw = await fetchPolls('approval', { subject: subj });
                if (appRaw && appRaw.length > 0) break;
            } catch(subErr) { }
        }
        STATE.approvalData = this.normalizeApproval(appRaw);
      } catch (e) {
        log(`App Fail: ${e}`);
        STATE.approvalData = [];
      }

      // Fallback Check
      if (STATE.gbData.length === 0 || STATE.approvalData.length === 0) {
        throw new Error("Missing datasets");
      }
      showStatus("Live data loaded successfully.", "success");

    } catch (e) {
      console.warn("Fallback to Demo", e);
      STATE.isDemoMode = true;
      showStatus("API unavailable. Showing DEMO MODE data.", "warn");
      STATE.gbData = generateMockData('gb');
      STATE.approvalData = generateMockData('approval');
    }

    $('loadingIndicator').style.display = 'none';
    this.refreshViews();
    
    window.addEventListener('resize', () => {
        Plotly.Plots.resize('gbChart');
        Plotly.Plots.resize('approvalChart');
    });
  },

  normalizeGB(list) {
    return list.map(p => {
      const dem = getAnswer(p, ['Dem', 'Democrat']);
      const rep = getAnswer(p, ['Rep', 'Republican']);
      if (dem === null || rep === null) return null;
      return {
        date: parseDate(p.end_date || p.start_date),
        dem: dem, rep: rep,
        pollster: p.pollster, sample_size: p.sample_size
      };
    }).filter(x => x);
  },

  normalizeApproval(list) {
    return list.map(p => {
      const app = getAnswer(p, ['Approve', 'Strongly Approve', 'Yes']);
      const dis = getAnswer(p, ['Disapprove', 'Strongly Disapprove', 'No']);
      if (app === null && dis === null) return null;
      return {
        date: parseDate(p.end_date || p.start_date),
        approve: app, disapprove: dis,
        pollster: p.pollster, sample_size: p.sample_size
      };
    }).filter(x => x);
  },

  refreshViews() {
    STATE.filterStrict = $('toggleFilter').checked;
    $('filterModeText').textContent = STATE.filterStrict ? "Strict Allowlist (Quality)" : "All Available Sources";

    const gbFiltered = STATE.gbData.filter(p => isAllowed(p.pollster));
    const appFiltered = STATE.approvalData.filter(p => isAllowed(p.pollster));

    const mapVal = (arr, key) => arr.map(p => ({ ...p, value: p[key] })).filter(p => p.value != null);

    // Generic Ballot Processing
    const demRaw = mapVal(gbFiltered, 'dem');
    const repRaw = mapVal(gbFiltered, 'rep');
    const demMA = calculateRollingAvg(demRaw, CONFIG.gbWindow);
    const repMA = calculateRollingAvg(repRaw, CONFIG.gbWindow);

    // Approval Processing
    const appRaw = mapVal(appFiltered, 'approve');
    const disRaw = mapVal(appFiltered, 'disapprove');
    const appMA = calculateRollingAvg(appRaw, CONFIG.approvalWindow);
    const disMA = calculateRollingAvg(disRaw, CONFIG.approvalWindow);

    updateStatsDual('gbStats', gbFiltered.length, demMA, repMA);
    updateStatsDual('approvalStats', appFiltered.length, appMA, disMA);

    renderDualChart('gbChart', [
      { name: "Democrats", raw: demRaw, ma: demMA, color: "#2563eb" }, 
      { name: "Republicans", raw: repRaw, ma: repMA, color: "#dc2626" }
    ], "Percentage (%)");

    renderDualChart('approvalChart', [
      { name: "Approve", raw: appRaw, ma: appMA, color: "#16a34a" }, 
      { name: "Disapprove", raw: disRaw, ma: disMA, color: "#dc2626" }
    ], "Percentage (%)");
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => app.init());
} else {
  app.init();
}
</script>
</body>
</html>
