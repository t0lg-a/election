<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>TX SD9 Analytics • Mission Control</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>

  <style>
    /* THEME VARIABLES 
       Designed for high-contrast "Mission Control" visibility
    */
    :root {
      --font-ui: 'Inter', -apple-system, system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      /* Light Mode Defaults */
      --bg-app: #f0f2f5;
      --bg-panel: rgba(255, 255, 255, 0.85);
      --bg-card: #ffffff;
      --ink-primary: #0f172a;
      --ink-secondary: #64748b;
      --border: rgba(148, 163, 184, 0.2);
      --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
      --glass: blur(16px) saturate(180%);
      
      --dem: #2563eb;       /* Rich Blue */
      --gop: #dc2626;       /* Rich Red */
      --dem-sub: #dbeafe;
      --gop-sub: #fee2e2;
      --neu: #64748b;

      --accent: #6366f1;    /* Indigo for UI elements */
    }

    /* Dark Mode Overrides */
    [data-theme="dark"] {
      --bg-app: #020617;
      --bg-panel: rgba(15, 23, 42, 0.75);
      --bg-card: #1e293b;
      --ink-primary: #f8fafc;
      --ink-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
      --shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
      
      --dem: #3b82f6;
      --gop: #ef4444;
      --dem-sub: rgba(59, 130, 246, 0.15);
      --gop-sub: rgba(239, 68, 68, 0.15);
    }

    * { box-sizing: border-box; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.1s ease; }
    
    html, body { height: 100%; margin: 0; padding: 0; font-family: var(--font-ui); background: var(--bg-app); color: var(--ink-primary); overflow: hidden; }
    
    #app { display: grid; grid-template-rows: auto 1fr; height: 100vh; }

    /* --- TOP BAR --- */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-bottom: 1px solid var(--border);
      z-index: 2000;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-logo { 
      width: 14px; height: 14px; border-radius: 50%; 
      background: linear-gradient(135deg, var(--gop), var(--dem)); 
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
    }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 800; letter-spacing: -0.02em; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--ink-secondary); font-weight: 500; }
    
    .controls { display: flex; align-items: center; gap: 12px; }
    
    /* Metrics Chips */
    .chip {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; font-weight: 600;
      padding: 4px 10px; border-radius: 99px;
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--ink-secondary);
      box-shadow: var(--shadow);
    }
    .chip span { font-family: var(--font-mono); font-weight: 700; color: var(--ink-primary); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--neu); transition: background 0.3s; }
    .status-dot.ok { background: #10b981; box-shadow: 0 0 6px #10b981; }

    /* Theme Toggle */
    .theme-toggle {
      background: none; border: 1px solid var(--border);
      color: var(--ink-primary); padding: 6px; border-radius: 8px;
      cursor: pointer; display: flex;
    }
    .theme-toggle:hover { background: var(--border); }

    /* --- LAYOUT --- */
    .main {
      display: grid; grid-template-columns: 420px 1fr; gap: 16px;
      padding: 16px; height: 100%; min-height: 0;
    }

    /* --- LEFT PANEL --- */
    .panel {
      display: flex; flex-direction: column;
      background: var(--bg-panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 0;
    }

    .panel-head { padding: 20px 20px 10px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    
    /* Search */
    .search-wrap { position: relative; margin-bottom: 16px; }
    #searchBox {
      width: 100%; padding: 10px 12px 10px 36px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 10px; color: var(--ink-primary);
      font-family: var(--font-ui); font-size: 13px; font-weight: 500;
      outline: none; transition: box-shadow 0.2s;
    }
    #searchBox:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ink-secondary); width: 14px; }

    /* Prec Info */
    .prec-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; }
    .prec-id { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
    .prec-meta { font-family: var(--font-mono); font-size: 11px; color: var(--ink-secondary); }

    /* Tabs */
    .tabs { display: flex; gap: 4px; padding: 2px; background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); }
    .tab {
      flex: 1; text-align: center; padding: 6px;
      font-size: 11px; font-weight: 600; cursor: pointer;
      border-radius: 8px; color: var(--ink-secondary);
      user-select: none;
    }
    .tab.active { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(99,102,241,0.4); }

    .panel-body { padding: 0 20px 20px 20px; overflow-y: auto; flex: 1; }
    
    /* Metrics Cards */
    .card {
      margin-top: 16px; padding: 16px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px;
    }
    .card-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; color: var(--ink-secondary); margin-bottom: 12px; display: flex; justify-content: space-between; }
    
    /* Big Number */
    .stat-row { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 12px; }
    .stat-val { font-family: var(--font-mono); font-size: 28px; font-weight: 700; letter-spacing: -1px; }
    .stat-label { font-size: 12px; font-weight: 600; color: var(--ink-secondary); }
    
    .dem { color: var(--dem); }
    .gop { color: var(--gop); }
    .neu { color: var(--ink-primary); }

    /* Charts */
    .chart-bar-bg { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; position: relative; }
    .chart-bar-fill { height: 100%; position: absolute; transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1); }
    .fill-d { background: var(--dem); left: 0; }
    .fill-r { background: var(--gop); right: 0; }
    .chart-labels { display: flex; justify-content: space-between; margin-top: 6px; font-family: var(--font-mono); font-size: 10px; font-weight: 600; color: var(--ink-secondary); }

    /* Scatterplot Container */
    #scatterContainer { width: 100%; height: 150px; margin-top: 10px; }
    .scatter-point { fill: var(--ink-secondary); opacity: 0.3; transition: opacity 0.2s; }
    .scatter-point.active { opacity: 1; stroke: var(--ink-primary); stroke-width: 2px; r: 5; }

    /* Mini Lists */
    .list-row { 
      display: flex; justify-content: space-between; padding: 8px 0; 
      border-bottom: 1px dashed var(--border); cursor: pointer;
      font-family: var(--font-mono); font-size: 11px;
    }
    .list-row:hover { background: var(--bg-app); padding-left: 4px; padding-right: 4px; border-radius: 4px; }
    .list-row:last-child { border-bottom: none; }

    /* --- MAP CONTAINER --- */
    .map-card {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    #map { width: 100%; height: 100%; background: var(--bg-app); }

    /* Floating Legend */
    .legend {
      position: absolute; bottom: 20px; right: 20px;
      width: 280px; padding: 16px;
      background: var(--bg-panel);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      z-index: 1000;
    }
    #legendGradient { height: 12px; border-radius: 6px; margin: 10px 0; border: 1px solid var(--border); }
    .legend-scale { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 10px; color: var(--ink-secondary); }

    /* Tooltip Customization */
    .leaflet-tooltip {
      background: var(--bg-panel) !important;
      border: 1px solid var(--border) !important;
      color: var(--ink-primary) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important;
      border-radius: 8px !important;
      font-family: var(--font-ui) !important;
      font-size: 12px !important;
      padding: 8px 12px !important;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
      .legend { width: auto; left: 20px; right: 20px; bottom: 20px; }
    }
  </style>
</head>

<body>

<div id="app">
  <div class="topbar">
    <div class="brand">
      <div class="brand-logo"></div>
      <div class="brand-text">
        <h1>TX SD9 Analytics</h1>
        <p>Precinct-Level Performance Model</p>
      </div>
    </div>

    <div class="controls">
      <div class="chip">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Init...</span>
      </div>
      <button class="theme-toggle" id="themeBtn" aria-label="Toggle Theme">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
        </svg>
      </button>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-head">
        <div class="search-wrap">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" id="searchBox" placeholder="Search Precinct ID..." list="precinctList">
          <datalist id="precinctList"></datalist>
        </div>

        <div class="prec-header">
          <div class="prec-id" id="lblPrecinct">District Overview</div>
          <div class="prec-meta" id="lblCount">Loading Data...</div>
        </div>

        <div class="tabs">
          <div class="tab active" data-mode="trend">Trend</div>
          <div class="tab" data-mode="swing">Swing</div>
          <div class="tab" data-mode="2026">2026</div>
          <div class="tab" data-mode="2022">2022</div>
        </div>
      </div>

      <div class="panel-body" id="panelBody">
        <div class="card">
          <div class="card-title">
            <span id="metricTitle">Trend (Normalized)</span>
            <span id="metricSubtitle">2026 vs 2022</span>
          </div>
          <div class="stat-row">
            <div class="stat-val neu" id="mainVal">—</div>
            <div class="stat-label" id="mainLabel">Shift</div>
          </div>
          
          <div class="card-title" style="margin-top:20px;">District Distribution</div>
          <div id="scatterContainer"></div>
          <div class="chart-labels">
            <span>More GOP</span>
            <span>More DEM</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Vote Share</div>
          
          <div style="margin-bottom: 16px;">
            <div class="chart-labels" style="margin-bottom:4px;">
              <span>2026 Result</span>
              <span id="txt26">—</span>
            </div>
            <div class="chart-bar-bg">
              <div class="chart-bar-fill fill-d" id="bar26d" style="width:0%"></div>
              <div class="chart-bar-fill fill-r" id="bar26r" style="width:0%"></div>
            </div>
          </div>

          <div>
            <div class="chart-labels" style="margin-bottom:4px;">
              <span>2022 Result</span>
              <span id="txt22">—</span>
            </div>
            <div class="chart-bar-bg">
              <div class="chart-bar-fill fill-d" id="bar22d" style="width:0%"></div>
              <div class="chart-bar-fill fill-r" id="bar22r" style="width:0%"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Extremes (Top 5)</div>
          <div id="extremesList"></div>
        </div>

      </div>
    </div>

    <div class="map-card">
      <div id="map"></div>
      
      <div class="legend">
        <div class="card-title" id="legendTitle">Trend (Margin50)</div>
        <div class="legend-scale" style="margin-bottom:4px">
          <span class="gop">R+40</span>
          <span class="neu">Even</span>
          <span class="dem">D+40</span>
        </div>
        <div id="legendGradient"></div>
        <div class="chart-labels">
          <span id="legendMin">Red Shift</span>
          <span id="legendMax">Blue Shift</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * MISSION CONTROL: TX SD9 ANALYTICS
 * Enhanced Logic for Data Handling, Visualization, and Map Interaction
 */

// --- CONFIGURATION ---
const CFG = {
  csv: "sd9_precinct_5050_swing.csv",
  json: "tarrant.geojson",
  district: "9",
  clamp: 40,
  styles: {
    defaultWeight: 0.5,
    selectedWeight: 2.5,
    colorD: "#3b82f6",
    colorR: "#ef4444",
    colorN: "#f1f5f9"
  }
};

// --- STATE ---
const STATE = {
  data: {},       // Map<PrecinctID, DataObject>
  geo: null,      // GeoJSON FeatureCollection
  stats: {},      // District-wide aggregates
  selected: null, // Currently selected precinct ID (null = district view)
  mode: "trend",  // trend | swing | 2026 | 2022
  layer: null     // Leaflet GeoJSON layer ref
};

// --- DOM UTILS ---
const $ = id => document.getElementById(id);
const fmt = (n, d=1) => (n==null || isNaN(n)) ? "—" : (+n).toFixed(d);
const fmtS = (n, d=1) => {
  if (n==null || isNaN(n)) return "—";
  const s = (+n > 0 ? "D+" : (+n < 0 ? "R+" : ""));
  return `${s}${Math.abs(n).toFixed(d)}`;
};

// --- COLOR SCALES (D3) ---
// Using D3 interpolator for smooth gradients
const scaleRdBu = d3.scaleSequential(d3.interpolateRdBu).domain([-1, 1]); 

function getColor(val, clampVal) {
  if (val == null || isNaN(val)) return "rgba(128,128,128,0.1)"; // Ghost color for no data
  // Normalize value to -1...1 based on clamp
  let t = Math.max(-clampVal, Math.min(clampVal, val)) / clampVal;
  // D3 RdBu goes Red(0) -> Blue(1). 
  // If val is positive (Dem), we want Blue. If negative (GOP), Red.
  // t is -1 (R) to 1 (D). Map to 0..1 => (t+1)/2
  return scaleRdBu((t + 1) / 2);
}

function getMetric(row, m=STATE.mode) {
  if (!row) return null;
  switch(m) {
    case "trend": return row.margin50_swing;
    case "swing": return row.margin_raw_swing;
    case "2026": return row["2026_margin_raw"];
    case "2022": return row["2022_margin_raw"];
  }
  return null;
}

// --- INITIALIZATION ---
async function init() {
  try {
    $("statusText").textContent = "Loading Data...";
    
    // Parallel Load
    const [csvData, geoData] = await Promise.all([
      d3.csv(CFG.csv),
      d3.json(CFG.json)
    ]);

    processData(csvData);
    processGeo(geoData);
    
    // UI Init
    initMap();
    initCharts();
    initInteractions();
    
    // Initial Render
    $("statusText").textContent = "Online";
    $("statusDot").classList.add("ok");
    renderDashboard();

  } catch (e) {
    console.error(e);
    $("statusText").textContent = "Data Error";
    $("statusDot").classList.remove("ok");
    $("statusDot").style.background = "red";
    alert("Error loading data files. Ensure CSV and GeoJSON are in the same directory.");
  }
}

// --- DATA PROCESSING ---
function processData(rows) {
  // Aggregate rows by precinct (handle duplicates via mean if necessary)
  const temp = {};
  
  rows.forEach(r => {
    // Extract ID
    const pid = r.precinct.match(/\d+/)?.[0];
    if (!pid) return;
    
    // numeric conversion helper
    const n = k => parseFloat(r[k]);

    const d = {
      id: pid,
      "2022_D_pct": n("2022_D_pct"),
      "2022_R_pct": n("2022_R_pct"),
      "2026_D_pct": n("2026_D_pct"),
      "2026_R_pct": n("2026_R_pct"),
      "margin50_swing": n("margin50_swing"),
      "D50_swing": n("D50_swing"),
      "2026_D50": n("2026_D50"),
      "2022_D50": n("2022_D50")
    };

    // Calculate derived fields if missing
    d["2022_margin_raw"] = d["2022_D_pct"] - d["2022_R_pct"];
    d["2026_margin_raw"] = d["2026_D_pct"] - d["2026_R_pct"];
    d["margin_raw_swing"] = d["2026_margin_raw"] - d["2022_margin_raw"];

    // Store
    temp[pid] = d;
  });

  STATE.data = temp;

  // Calculate District Stats (Naive average of precincts for now, weighted if pop data existed)
  const vals = Object.values(STATE.data);
  const avg = (key) => d3.mean(vals, d => d[key]);
  
  STATE.stats = {
    count: vals.length,
    trend_avg: avg("margin50_swing"),
    swing_avg: avg("margin_raw_swing"),
    m26_avg: avg("2026_margin_raw"),
    m22_avg: avg("2022_margin_raw")
  };
  
  // Populate Search Datalist
  const dl = $("precinctList");
  Object.keys(STATE.data).sort().forEach(pid => {
    const opt = document.createElement("option");
    opt.value = pid;
    dl.appendChild(opt);
  });
}

function processGeo(json) {
  // Filter for SD9
  const features = json.features.filter(f => String(f.properties.Senate) === CFG.district);
  STATE.geo = { type: "FeatureCollection", features: features };
}

// --- MAP ENGINE ---
let map;

function initMap() {
  map = L.map('map', { 
    zoomControl: false, 
    attributionControl: false 
  }).setView([32.75, -97.33], 10); // Center on Tarrant roughly

  L.control.zoom({ position: 'topright' }).addTo(map);
  
  // Add a nice CartoDB Light basemap (or Dark based on theme)
  const updateBasemap = () => {
    const isDark = document.documentElement.getAttribute("data-theme") === "dark";
    const url = isDark 
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
    
    map.eachLayer(l => { if (l instanceof L.TileLayer) map.removeLayer(l); });
    L.tileLayer(url, { opacity: isDark ? 0.6 : 1 }).addTo(map);
  };
  
  // Theme observer
  const observer = new MutationObserver(updateBasemap);
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
  updateBasemap();

  renderMapLayer();
}

function renderMapLayer() {
  if (STATE.layer) map.removeLayer(STATE.layer);

  STATE.layer = L.geoJSON(STATE.geo, {
    style: (feature) => {
      const pid = String(feature.properties.Precinct);
      const row = STATE.data[pid];
      const val = getMetric(row);
      const isSel = STATE.selected === pid;
      
      return {
        fillColor: getColor(val, CFG.clamp),
        fillOpacity: row ? 0.85 : 0.1,
        color: isSel ? (val > 0 ? CFG.styles.colorD : CFG.styles.colorR) : "#64748b",
        weight: isSel ? 3 : 0.5,
        opacity: isSel ? 1 : 0.3
      };
    },
    onEachFeature: (feature, layer) => {
      const pid = String(feature.properties.Precinct);
      
      // Tooltip
      const row = STATE.data[pid];
      const val = getMetric(row);
      const tipContent = `
        <div style="font-weight:700; margin-bottom:4px;">Precinct ${pid}</div>
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <span>${STATE.mode.toUpperCase()}</span>
          <span style="font-family:'JetBrains Mono'; font-weight:700; color:${val>0?CFG.styles.colorD:CFG.styles.colorR}">${fmtS(val)}</span>
        </div>
      `;
      layer.bindTooltip(tipContent, { sticky: true });

      // Click
      layer.on('click', () => {
        selectPrecinct(pid);
        L.DomEvent.stop(feature); // prevent map click clearing
      });
      
      // Hover (Highlight)
      layer.on('mouseover', () => {
        if (STATE.selected !== pid) {
          layer.setStyle({ weight: 2, color: "#94a3b8", opacity: 0.8 });
          layer.bringToFront();
        }
      });
      layer.on('mouseout', () => {
        if (STATE.selected !== pid) {
          STATE.layer.resetStyle(layer);
        }
      });
    }
  }).addTo(map);

  // Zoom label logic (X-Ray)
  map.on('zoomend', () => {
    if (map.getZoom() > 12) {
      // Could add text labels here if desired for extreme detail
    }
  });

  if (!STATE.selected) map.fitBounds(STATE.layer.getBounds());
}

// --- DASHBOARD LOGIC ---
function selectPrecinct(pid) {
  if (pid && !STATE.data[pid]) {
    console.warn("Precinct data not found:", pid);
    return;
  }
  
  STATE.selected = pid === STATE.selected ? null : pid; // Toggle
  
  renderDashboard();
  renderMapLayer(); // Re-style map to show selection border
  
  if (STATE.selected) {
    // Zoom to feature
    const layer = STATE.layer.getLayers().find(l => String(l.feature.properties.Precinct) === pid);
    if (layer) map.flyToBounds(layer.getBounds(), { padding: [50, 50], duration: 1.0 });
    $("searchBox").value = pid;
  } else {
    $("searchBox").value = "";
    map.flyToBounds(STATE.layer.getBounds(), { duration: 1.0 });
  }
}

function renderDashboard() {
  const isDist = STATE.selected === null;
  const pid = STATE.selected;
  const row = isDist ? null : STATE.data[pid];
  
  // 1. Header
  $("lblPrecinct").textContent = isDist ? "District Overview" : `Precinct ${pid}`;
  $("lblCount").textContent = isDist 
    ? `${STATE.stats.count} Precincts Loaded` 
    : "Single Precinct Analysis";

  // 2. Main Metric (Trend/Swing/etc)
  const mVal = isDist 
    ? (STATE.mode === 'trend' ? STATE.stats.trend_avg : STATE.mode === 'swing' ? STATE.stats.swing_avg : STATE.mode === '2026' ? STATE.stats.m26_avg : STATE.stats.m22_avg)
    : getMetric(row);
  
  const mEl = $("mainVal");
  mEl.textContent = fmtS(mVal);
  mEl.className = "stat-val " + (mVal > 0.1 ? "dem" : (mVal < -0.1 ? "gop" : "neu"));
  
  $("metricSubtitle").textContent = 
    STATE.mode === "trend" ? "Normalized Margin Shift" : 
    STATE.mode === "swing" ? "Raw Margin Swing" : 
    `Margin (D-R)`;

  // 3. Vote Share Bars
  updateBars(isDist, row);

  // 4. Update Scatter/Distribution Chart
  updateCharts(isDist, row);

  // 5. Update Extremes List
  updateExtremes();

  // 6. Legend Gradient
  updateLegend();
}

function updateBars(isDist, row) {
  // If District, average. If Precinct, row data.
  // Note: For District, averaging percentages is mathematically iffy without population weights, 
  // but acceptable for a visual overview of "Average Precinct Behavior".
  
  const d26 = isDist ? d3.mean(Object.values(STATE.data), d=>d["2026_D_pct"]) : row["2026_D_pct"];
  const r26 = isDist ? d3.mean(Object.values(STATE.data), d=>d["2026_R_pct"]) : row["2026_R_pct"];
  
  const d22 = isDist ? d3.mean(Object.values(STATE.data), d=>d["2022_D_pct"]) : row["2022_D_pct"];
  const r22 = isDist ? d3.mean(Object.values(STATE.data), d=>d["2022_R_pct"]) : row["2022_R_pct"];

  const setB = (yr, d, r) => {
    $(`bar${yr}d`).style.width = `${d}%`;
    $(`bar${yr}r`).style.width = `${r}%`;
    $(`txt${yr}`).textContent = `D ${fmt(d)}% / R ${fmt(r)}%`;
  };

  setB("26", d26, r26);
  setB("22", d22, r22);
}

// --- D3 CHARTS ---
function initCharts() {
  // One-time setup if needed, but we mostly redraw on update
}

function updateCharts(isDist, row) {
  // We will build a scatterplot: X = 2022 Margin, Y = 2026 Margin
  // This visualizes Swing (deviation from diagonal).
  
  const container = $("scatterContainer");
  container.innerHTML = ""; // Clear
  
  const w = container.clientWidth;
  const h = 150;
  const pad = 10;
  
  const svg = d3.select(container).append("svg")
    .attr("width", w).attr("height", h);

  // Data
  const data = Object.values(STATE.data).filter(d => 
    d["2022_margin_raw"] != null && d["2026_margin_raw"] != null
  );

  // Scales
  const x = d3.scaleLinear().domain([-100, 100]).range([pad, w - pad]);
  const y = d3.scaleLinear().domain([-100, 100]).range([h - pad, pad]); // Y inverted

  // Zero lines
  svg.append("line").attr("x1", x(0)).attr("y1", pad).attr("x2", x(0)).attr("y2", h-pad).attr("stroke", "var(--border)").attr("stroke-dasharray", "4");
  svg.append("line").attr("x1", pad).attr("y1", y(0)).attr("x2", w-pad).attr("y2", y(0)).attr("stroke", "var(--border)").attr("stroke-dasharray", "4");

  // Diagonal (No change line)
  svg.append("line")
     .attr("x1", x(-100)).attr("y1", y(-100))
     .attr("x2", x(100)).attr("y2", y(100))
     .attr("stroke", "var(--border)")
     .attr("stroke-opacity", 0.5);

  // Dots
  svg.selectAll("circle")
    .data(data)
    .enter()
    .append("circle")
    .attr("cx", d => x(d["2022_margin_raw"]))
    .attr("cy", d => y(d["2026_margin_raw"]))
    .attr("r", 2.5)
    .attr("class", d => {
      if (isDist) return "scatter-point";
      return d.id === row.id ? "scatter-point active" : "scatter-point";
    })
    .attr("fill", d => {
       // Color by currently selected metric (e.g. Trend)
       const v = getMetric(d);
       return v > 0 ? "var(--dem)" : "var(--gop)";
    });
    
  if (!isDist) {
     // Add a label for the selected one
     const d = row;
     svg.append("text")
        .attr("x", x(d["2022_margin_raw"]))
        .attr("y", y(d["2026_margin_raw"]) - 8)
        .text(d.id)
        .attr("text-anchor", "middle")
        .attr("fill", "var(--ink-primary)")
        .attr("font-size", "10px")
        .attr("font-weight", "bold");
  }
}

function updateExtremes() {
  const el = $("extremesList");
  el.innerHTML = "";
  
  // Sort data by current metric
  const sorted = Object.values(STATE.data)
    .filter(d => getMetric(d) != null)
    .sort((a, b) => getMetric(b) - getMetric(a)); // Descending (Dem first)
  
  // Take top 5 Dem and Bottom 5 GOP
  const topD = sorted.slice(0, 3);
  const topR = sorted.slice(-3).reverse();
  
  const mkRow = (d) => {
    const val = getMetric(d);
    const div = document.createElement("div");
    div.className = "list-row";
    div.innerHTML = `<span>P ${d.id}</span> <span style="color:${val>0?'var(--dem)':'var(--gop)'}">${fmtS(val)}</span>`;
    div.onclick = () => selectPrecinct(d.id);
    return div;
  };

  topD.forEach(d => el.appendChild(mkRow(d)));
  
  const sep = document.createElement("div");
  sep.style.textAlign = "center"; sep.style.color="var(--border)"; sep.textContent = "•••";
  el.appendChild(sep);
  
  topR.forEach(d => el.appendChild(mkRow(d)));
}

function updateLegend() {
  const grad = $("legendGradient");
  // CSS Gradient RdBu
  grad.style.background = `linear-gradient(90deg, 
    ${d3.interpolateRdBu(0.1)} 0%, 
    ${d3.interpolateRdBu(0.5)} 50%, 
    ${d3.interpolateRdBu(0.9)} 100%)`;
    
  $("legendTitle").textContent = `${STATE.mode.toUpperCase()} Map`;
}

// --- INTERACTIONS ---
function initInteractions() {
  // Theme Toggle
  $("themeBtn").addEventListener("click", () => {
    const html = document.documentElement;
    const cur = html.getAttribute("data-theme");
    html.setAttribute("data-theme", cur === "dark" ? "light" : "dark");
  });

  // Tabs
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      STATE.mode = t.dataset.mode;
      renderMapLayer();
      renderDashboard();
    });
  });

  // Search
  $("searchBox").addEventListener("change", (e) => {
    const pid = e.target.value;
    if (STATE.data[pid]) {
      selectPrecinct(pid);
    }
  });
  
  // Clear on map click (background)
  map.on('click', () => {
    if (STATE.selected) selectPrecinct(STATE.selected); // toggle off
  });
}

// --- BOOT ---
window.addEventListener("DOMContentLoaded", init);

</script>
</body>
</html>
